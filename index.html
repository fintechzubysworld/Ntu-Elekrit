<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ntu Electricity Management System v3.8.2 (Cloud Edition)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #2980b9;
            --accent: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --storage-ok: #27ae60;
            --storage-bad: #e74c3c;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 0; padding: 0; font-size: 14px; }
        
        /* Layout */
        .container { max-width: 1000px; margin: 20px auto; background: white; padding: 0; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 20px; }
        
        /* Storage Indicator */
        .storage-status { font-size: 11px; padding: 4px 8px; border-radius: 4px; background: rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: var(--storage-bad); }
        .dot.active { background: var(--storage-ok); box-shadow: 0 0 5px #2ecc71; }

        /* Navigation */
        .nav-bar { background: var(--dark); padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .nav-btn { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #bdc3c7; padding: 8px 12px; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); }
        
        /* Content Sections */
        .section { padding: 25px; display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        input:focus { border-color: var(--secondary); outline: none; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-sm { padding: 5px 10px; font-size: 11px; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn:hover { opacity: 0.9; }

        /* Tables */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f9fa; color: var(--dark); font-weight: 700; }
        tr:nth-child(even) { background: #fcfcfc; }
        tr:hover { background: #f1f1f1; }

        /* Receipt & Branding */
        .receipt-container { max-width: 400px; margin: 0 auto; border: 2px dashed #333; padding: 20px; background: #fffbe6; font-family: 'Courier New', Courier, monospace; position: relative; }
        .branding-seal { max-width: 80px; position: absolute; bottom: 60px; right: 20px; opacity: 0.8; }
        .branding-sig { max-width: 120px; border-bottom: 1px solid #333; display: block; margin: 10px 0 5px 0; }

        /* Stats */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border: 1px solid #eee; padding: 20px; border-radius: 8px; border-left: 4px solid var(--secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { margin: 0; font-size: 24px; color: var(--primary); }
        .stat-card p { margin: 5px 0 0; color: #7f8c8d; font-size: 13px; }

        .alert { padding: 12px; margin-bottom: 20px; border-radius: 4px; display: none; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        @media print {
            .nav-bar, .no-print, .header { display: none; }
            .container { box-shadow: none; border: none; margin: 0; max-width: 100%; }
            .receipt-container { border: 2px solid black; }
        }
        .hidden { display: none !important; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; color: white; }
        .badge-superadmin { background: #8e44ad; }
        .badge-admin { background: #2980b9; }
        .badge-leader { background: #e67e22; }
        .badge-collector { background: #27ae60; }
    </style>
</head>
<body>

<div id="view-login" class="container" style="max-width: 400px; margin-top: 60px; padding: 20px;">
    <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="color: var(--primary);">Ntu Electricity System</h2>
        <p>Google Cloud Vault Edition</p>
    </div>
    
    <div id="cloud-setup-box" style="background: #eef2f7; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: center;">
        <p style="margin-top:0; font-size:12px; color:#555;">Cloud Sync Status</p>
        <div id="storage-msg" style="font-weight:bold; color: var(--danger); margin-bottom:10px;">Cloud Disconnected</div>
        <button class="btn btn-warning btn-sm" onclick="CloudStorage.initiateAuth()" id="btn-connect-drive">☁ Sign-in to Google Drive</button>
        <div id="history-hint" style="font-size: 10px; color: #777; margin-top: 5px;">Required to load system data.</div>
    </div>

    <div id="login-alert" class="alert"></div>
    <form onsubmit="event.preventDefault(); Auth.login();">
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="login-user" required>
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="login-pass" required>
        </div>
        <button type="submit" id="btn-login-submit" class="btn btn-primary" style="width: 100%;" disabled>Wait for Cloud Sync...</button>
    </form>
</div>

<div id="view-app" class="container hidden">
    <div class="header">
        <div>
            <h2>Ntu Electricity Management</h2>
            <small id="user-role-display" style="opacity: 0.9; font-size: 12px;"></small>
        </div>
        <div class="no-print" style="display: flex; gap: 10px; align-items: center;">
            <div class="storage-status" onclick="CloudStorage.initiateAuth()">
                <span class="dot" id="status-dot"></span>
                <span id="status-text">Cloud Syncing</span>
            </div>
            <button onclick="Auth.logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" onclick="Router.go('dashboard')" id="nav-dashboard">Dashboard</button>
        <span id="field-menu" class="hidden" style="display: contents;">
            <button class="nav-btn" onclick="Router.go('register')" id="nav-register">Register Household</button>
            <button class="nav-btn" onclick="Router.go('collection')" id="nav-collection">Collection</button>
            <button class="nav-btn" onclick="Router.go('statement')" id="nav-statement">Statement</button>
        </span>
        <button class="nav-btn" onclick="Router.go('reports')" id="nav-reports">Reports</button>
        <span id="admin-menu" class="hidden" style="display: contents;">
            <button class="nav-btn" onclick="Router.go('remittance')" id="nav-remittance">Remittance</button>
            <button class="nav-btn" onclick="Router.go('billing')" id="nav-billing">Billing</button>
            <button class="nav-btn" onclick="Router.go('settings')" id="nav-settings">Branding & Users</button>
            <button class="nav-btn" onclick="Router.go('data')" id="nav-data">Backups</button>
        </span>
        <button class="nav-btn hidden" onclick="Router.go('audit')" id="nav-audit">Audit</button>
    </div>

    <div style="padding: 0 25px; margin-top: 15px;">
        <div id="global-alert" class="alert"></div>
        <div id="autosave-indicator" style="display:none; color: var(--accent); font-size: 11px; text-align: right; font-style: italic;">Updating Cloud...</div>
    </div>

    <div id="dashboard" class="section active">
        <div class="stats-container">
            <div class="stat-card">
                <h3 id="dash-households">0</h3>
                <p>Households</p>
            </div>
            <div class="stat-card">
                <h3 id="dash-collected">₦0.00</h3>
                <p>Household Payments</p>
            </div>
            <div class="stat-card">
                <h3 id="dash-remitted" style="color: var(--accent);">₦0.00</h3>
                <p>Kindred Remittances</p>
            </div>
        </div>
        <h3>Kindred Overviews</h3>
        <div class="table-responsive">
            <table>
                <thead><tr><th>Kindred</th><th>Allocated Bill</th><th>Collected</th><th>Remitted</th><th>Balance</th></tr></thead>
                <tbody id="dash-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="register" class="section">
        <h3>Register New Household</h3>
        <div class="form-grid">
            <div class="form-group"><label>Kindred</label><select id="reg-kindred"><option>Oduebo</option><option>Oparadim</option><option>Ezealaoma</option></select></div>
            <div class="form-group"><label>Sub-Kindred</label><input type="text" id="reg-sub" placeholder="e.g. Umueze"></div>
            <div class="form-group"><label>Owner Name</label><input type="text" id="reg-owner" placeholder="Full Name"></div>
            <div class="form-group"><label>Phone</label><input type="text" id="reg-phone" placeholder="080..."></div>
        </div>
        <button class="btn btn-primary" onclick="App.registerHousehold()">Save & Generate ID</button>
    </div>

    <div id="collection" class="section">
        <h3>Payment Collection</h3>
        <div style="background: var(--light); padding: 20px; border-radius: 8px;">
            <div class="form-grid">
                <div class="form-group"><label>Account ID</label><input type="text" id="pay-acc" placeholder="e.g. ODUMJO55"></div>
                <div class="form-group"><label>Amount (₦)</label><input type="number" id="pay-amt"></div>
                <div class="form-group"><label>Date</label><input type="date" id="pay-date"></div>
            </div>
            <button class="btn btn-success" onclick="App.processCollection()">Submit Payment</button>
        </div>
    </div>

    <div id="remittance" class="section">
        <h3>Kindred to Admin Remittance</h3>
        <div class="form-grid">
            <div class="form-group"><label>Kindred</label><select id="remit-kindred"><option>Oduebo</option><option>Oparadim</option><option>Ezealaoma</option></select></div>
            <div class="form-group"><label>Amount (₦)</label><input type="number" id="remit-amt"></div>
        </div>
        <button class="btn btn-primary" onclick="App.processRemittance()">Record Remittance</button>
        <div class="table-responsive">
            <table><thead><tr><th>Date</th><th>Kindred</th><th>Amount</th><th>User</th></tr></thead><tbody id="remit-history-body"></tbody></table>
        </div>
    </div>

    <div id="settings" class="section">
        <div class="form-grid">
            <div class="stat-card">
                <h3>Branding</h3>
                <label>Official Seal</label>
                <input type="file" accept="image/*" onchange="App.handleBrandingUpload('seal', this)">
                <div id="preview-seal" style="margin-top:10px"></div>
                
                <label style="margin-top:15px">Signature</label>
                <input type="file" accept="image/*" onchange="App.handleBrandingUpload('signature', this)">
                <div id="preview-sig" style="margin-top:10px"></div>
            </div>
            <div class="stat-card">
                <h3>User Accounts</h3>
                <input type="text" id="set-user" placeholder="Username">
                <input type="text" id="set-pass" placeholder="Password">
                <select id="set-role"><option value="collector">Collector</option><option value="admin">Admin</option></select>
                <button class="btn btn-primary btn-sm" onclick="App.saveUser()">Add User</button>
                <div id="user-list" style="margin-top:10px"></div>
            </div>
        </div>
    </div>

    <div id="statement" class="section">
        <h3>Statement Lookup</h3>
        <input type="text" id="stmt-acc" placeholder="Enter Account ID" onchange="App.loadStatement(this.value)">
        <div id="statement-content" style="margin-top:20px"></div>
    </div>

    <div id="receipt-view" class="section">
        <div class="no-print"><button class="btn" onclick="Router.go('dashboard')">Back</button> <button class="btn btn-success" onclick="window.print()">Print</button></div>
        <div id="receipt-content" class="receipt-container"></div>
    </div>
</div>

<script>
// --- CLOUD CONFIGURATION ---
const CLOUD_CFG = {
    API_KEY: 'AIzaSyCMaOxkZQZEKp-3_WlktsTY4SgcJaKKVkg',
    CLIENT_ID: '309083177169-ltmc6ns4kg579tngf5m94e7hgrajv5mj.apps.googleusercontent.com',
    SCOPES: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly",
    DISCOVERY_DOC: "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"
};

let tokenClient;
let gapiInited = false;
let gisInited = false;

const CloudStorage = {
    fileId: null,
    
    init: async () => {
        gapi.load('client', async () => {
            await gapi.client.init({ apiKey: CLOUD_CFG.API_KEY, discoveryDocs: [CLOUD_CFG.DISCOVERY_DOC] });
            gapiInited = true;
            CloudStorage.tryAutoLogin();
        });

        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLOUD_CFG.CLIENT_ID,
            scope: CLOUD_CFG.SCOPES,
            callback: (resp) => CloudStorage.handleAuthResponse(resp),
        });
        gisInited = true;
    },

    tryAutoLogin: () => {
        const token = localStorage.getItem('gdrive_token');
        if (token) {
            gapi.client.setToken({ access_token: token });
            CloudStorage.connect();
        }
    },

    initiateAuth: () => {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    },

    handleAuthResponse: async (resp) => {
        if (resp.error) return;
        localStorage.setItem('gdrive_token', resp.access_token);
        await CloudStorage.connect();
    },

    connect: async () => {
        document.getElementById('storage-msg').innerText = "☁ Linking Drive...";
        try {
            // Find the database file
            const list = await gapi.client.drive.files.list({
                q: "name = 'ntu_database.json' and trashed = false",
                fields: "files(id, name)"
            });

            if (list.result.files.length > 0) {
                CloudStorage.fileId = list.result.files[0].id;
                await DataMgr.loadFromCloud();
            } else {
                // Create if not exists
                const resp = await gapi.client.drive.files.create({
                    resource: { name: 'ntu_database.json', mimeType: 'application/json' },
                    fields: 'id'
                });
                CloudStorage.fileId = resp.result.id;
                await DataMgr.save(); // Save default structure
            }

            document.getElementById('status-dot').classList.add('active');
            document.getElementById('status-text').innerText = "Cloud Active";
            document.getElementById('storage-msg').innerText = "✅ Cloud Connected";
            document.getElementById('storage-msg').style.color = "var(--storage-ok)";
            document.getElementById('btn-login-submit').disabled = false;
            document.getElementById('btn-login-submit').innerText = "Access System";
        } catch (e) {
            console.error(e);
            document.getElementById('storage-msg').innerText = "❌ Sync Error";
        }
    }
};

// --- DATA MANAGER ---
const DataMgr = {
    data: {
        users: [{user:'Admin', pass:'admin123', role:'admin'}],
        households: [],
        transactions: [],
        remittances: [],
        ledgers: {Oduebo:{debt:0, remitted:0}, Oparadim:{debt:0, remitted:0}, Ezealaoma:{debt:0, remitted:0}},
        branding: {seal:'', signature:''},
        audit: []
    },

    save: async () => {
        if (!CloudStorage.fileId) return;
        document.getElementById('autosave-indicator').style.display = 'block';
        try {
            await gapi.client.request({
                path: '/upload/drive/v3/files/' + CloudStorage.fileId,
                method: 'PATCH',
                params: { uploadType: 'media' },
                body: JSON.stringify(DataMgr.data)
            });
            setTimeout(() => document.getElementById('autosave-indicator').style.display = 'none', 1000);
        } catch (e) {}
    },

    loadFromCloud: async () => {
        const resp = await gapi.client.drive.files.get({ fileId: CloudStorage.fileId, alt: 'media' });
        if (resp.result) {
            DataMgr.data = resp.result;
            App.updateBrandingPreviews();
        }
    }
};

// --- AUTH ---
const Auth = {
    user: null,
    login: () => {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const found = DataMgr.data.users.find(x => x.user === u && x.pass === p);
        if (found) {
            Auth.user = found;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            Router.init();
        } else {
            UI.alert('login-alert', 'Invalid credentials', 'error');
        }
    },
    logout: () => { location.reload(); }
};

// --- APP LOGIC ---
const App = {
    generateID: (k, s, o, p) => (k.slice(0,2)+s.slice(0,2)+o.slice(0,2)+p.slice(-2)).toUpperCase(),

    registerHousehold: () => {
        const k = document.getElementById('reg-kindred').value;
        const s = document.getElementById('reg-sub').value;
        const o = document.getElementById('reg-owner').value;
        const p = document.getElementById('reg-phone').value;
        const id = App.generateID(k, s, o, p);
        DataMgr.data.households.push({id, kindred:k, sub:s, owner:o, phone:p});
        DataMgr.save();
        alert("Registered! ID: " + id);
        Router.go('dashboard');
    },

    processCollection: () => {
        const id = document.getElementById('pay-acc').value;
        const amt = parseFloat(document.getElementById('pay-amt').value);
        const house = DataMgr.data.households.find(h => h.id === id);
        if (!house) return alert("Invalid Account");
        const tx = { acc:id, owner:house.owner, amount:amt, date:document.getElementById('pay-date').value, ref:'TX'+Date.now() };
        DataMgr.data.transactions.push(tx);
        DataMgr.save();
        Printer.printCollection(tx, house);
    },

    handleBrandingUpload: (type, input) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            DataMgr.data.branding[type] = e.target.result;
            DataMgr.save();
            App.updateBrandingPreviews();
        };
        reader.readAsDataURL(input.files[0]);
    },

    updateBrandingPreviews: () => {
        const b = DataMgr.data.branding;
        if(b.seal) document.getElementById('preview-seal').innerHTML = `<img src="${b.seal}" height="50">`;
        if(b.signature) document.getElementById('preview-sig').innerHTML = `<img src="${b.signature}" height="30">`;
    },

    loadDashboard: () => {
        document.getElementById('dash-households').innerText = DataMgr.data.households.length;
        const total = DataMgr.data.transactions.reduce((s,t) => s+t.amount, 0);
        document.getElementById('dash-collected').innerText = "₦" + total.toFixed(2);
        
        let html = '';
        ['Oduebo', 'Oparadim', 'Ezealaoma'].forEach(k => {
            const l = DataMgr.data.ledgers[k];
            html += `<tr><td>${k}</td><td>₦${l.debt}</td><td>-</td><td>₦${l.remitted}</td><td>₦${l.debt-l.remitted}</td></tr>`;
        });
        document.getElementById('dash-table-body').innerHTML = html;
    }
};

// --- ROUTER ---
const Router = {
    init: () => {
        const r = Auth.user.role;
        document.getElementById('user-role-display').innerText = `Logged in as: ${Auth.user.user} (${r})`;
        if(r === 'admin') {
            document.getElementById('admin-menu').classList.remove('hidden');
            document.getElementById('field-menu').classList.remove('hidden');
        } else {
            document.getElementById('field-menu').classList.remove('hidden');
        }
        Router.go('dashboard');
    },
    go: (id) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'dashboard') App.loadDashboard();
    }
};

// --- PRINTER ---
const Printer = {
    printCollection: (tx, house) => {
        const b = DataMgr.data.branding;
        const seal = b.seal ? `<img src="${b.seal}" class="branding-seal">` : '';
        const sig = b.signature ? `<img src="${b.signature}" class="branding-sig">` : '<br>______';
        document.getElementById('receipt-content').innerHTML = `
            ${seal}
            <h3 style="text-align:center">NTU ELECTRICITY RECEIPT</h3>
            <p><strong>Account:</strong> ${tx.acc} (${house.kindred})</p>
            <p><strong>Owner:</strong> ${tx.owner}</p>
            <hr>
            <h2 style="text-align:right">₦${tx.amount.toFixed(2)}</h2>
            <p>Date: ${tx.date}</p>
            <div style="margin-top:20px">${sig}<br><small>Authorized Officer</small></div>
        `;
        Router.go('receipt-view');
    }
};

const UI = {
    alert: (id, msg, type) => {
        const el = document.getElementById(id);
        el.innerText = msg; el.className = `alert alert-${type}`; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }
};

window.onload = CloudStorage.init;
</script>
</body>
</html>
