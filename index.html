<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ntu Electricity Management System v3.8 (Auto-Link Storage)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #2980b9;
            --accent: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --storage-ok: #27ae60;
            --storage-bad: #e74c3c;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; margin: 0; padding: 0; font-size: 14px; }
        
        /* Layout */
        .container { max-width: 1000px; margin: 20px auto; background: white; padding: 0; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 20px; }
        
        /* Storage Indicator */
        .storage-status { font-size: 11px; padding: 4px 8px; border-radius: 4px; background: rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: var(--storage-bad); }
        .dot.active { background: var(--storage-ok); box-shadow: 0 0 5px #2ecc71; }

        /* Navigation */
        .nav-bar { background: var(--dark); padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        .nav-btn { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #bdc3c7; padding: 8px 12px; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); }
        
        /* Content Sections */
        .section { padding: 25px; display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        input:focus { border-color: var(--secondary); outline: none; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-sm { padding: 5px 10px; font-size: 11px; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: #3498db; color: white; }
        .btn:hover { opacity: 0.9; }

        /* Tables */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f9fa; color: var(--dark); font-weight: 700; }
        tr:nth-child(even) { background: #fcfcfc; }
        tr:hover { background: #f1f1f1; }

        /* Cards & Stats */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border: 1px solid #eee; padding: 20px; border-radius: 8px; border-left: 4px solid var(--secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { margin: 0; font-size: 24px; color: var(--primary); }
        .stat-card p { margin: 5px 0 0; color: #7f8c8d; font-size: 13px; }

        /* Messages */
        .alert { padding: 12px; margin-bottom: 20px; border-radius: 4px; display: none; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Receipt & Print */
        .receipt-container { max-width: 400px; margin: 0 auto; border: 2px dashed #333; padding: 20px; background: #fffbe6; font-family: 'Courier New', Courier, monospace; }
        
        @media print {
            .nav-bar, .no-print, .header { display: none; }
            .container { box-shadow: none; border: none; margin: 0; max-width: 100%; }
            .section { padding: 0; }
            .receipt-container { border: 2px solid black; position: absolute; top: 0; left: 0; width: 100%; max-width: 100%; }
        }

        .hidden { display: none !important; }
        
        /* Badges */
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; color: white; }
        .badge-superadmin { background: #8e44ad; }
        .badge-admin { background: #2980b9; }
        .badge-leader { background: #e67e22; }
        .badge-collector { background: #27ae60; }
        
        .text-muted { color: #7f8c8d; }
    </style>
</head>
<body>

<div id="view-login" class="container" style="max-width: 400px; margin-top: 60px; padding: 20px;">
    <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="color: var(--primary);">Ntu Electricity System v3.8</h2>
        <p>OneDrive Auto-Link Edition</p>
    </div>
    
    <div style="background: #eef2f7; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: center;">
        <p style="margin-top:0; font-size:12px; color:#555;">Data Storage Status</p>
        <div id="storage-msg" style="font-weight:bold; color: var(--danger); margin-bottom:10px;">Checking History...</div>
        <button class="btn btn-warning btn-sm" onclick="FileSystem.connect()" id="btn-connect-drive">üìÇ Connect Database Folder</button>
        <div id="history-hint" style="font-size: 10px; color: #777; margin-top: 5px;">First time? Select your OneDrive folder.</div>
    </div>

    <div id="login-alert" class="alert"></div>
    <form onsubmit="event.preventDefault(); Auth.login();">
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="login-user" required>
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="login-pass" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Access System</button>
    </form>
</div>

<div id="view-app" class="container hidden">
    <div class="header">
        <div>
            <h2>Ntu Electricity Management</h2>
            <small id="user-role-display" style="opacity: 0.9; font-size: 12px;"></small>
        </div>
        <div class="no-print" style="display: flex; gap: 10px; align-items: center;">
            <button onclick="App.showChangePassword()" class="btn btn-warning btn-sm" title="Change Password">üîê</button>
            <div class="storage-status" onclick="FileSystem.connect()" title="Click to reconnect/change">
                <span class="dot" id="status-dot"></span>
                <span id="status-text">Storage: Local</span>
            </div>
            <button onclick="Auth.logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" onclick="Router.go('dashboard')" id="nav-dashboard">Dashboard (Vault)</button>
        
        <span id="field-menu" class="hidden" style="display: contents;">
            <button class="nav-btn" onclick="Router.go('register')" id="nav-register-field">Register Household</button>
            <button class="nav-btn" onclick="Router.go('collection')" id="nav-collection">Collection</button>
            <button class="nav-btn" onclick="Router.go('statement')" id="nav-statement">Statement</button>
        </span>
        
        <button class="nav-btn" onclick="Router.go('reports')" id="nav-reports">Reports</button>
        
        <span id="admin-menu" class="hidden" style="display: contents;">
            <button class="nav-btn" onclick="Router.go('remittance')" id="nav-remittance">Kindred Remittance</button>
            <button class="nav-btn" onclick="Router.go('billing')" id="nav-billing">Billing</button>
            <button class="nav-btn" onclick="Router.go('data')" id="nav-data">Data & Backup</button>
            <button class="nav-btn" onclick="Router.go('settings')" id="nav-settings">User Mgmt</button>
        </span>

        <button class="nav-btn hidden" onclick="Router.go('audit')" id="nav-audit">Audit</button>
        <button class="nav-btn hidden" onclick="Router.go('wipe')" id="nav-wipe" style="color: #e74c3c;">Wipe</button>
    </div>

    <div style="padding: 0 25px; margin-top: 15px;">
        <div id="global-alert" class="alert"></div>
        <div id="autosave-indicator" style="display:none; color: var(--accent); font-size: 11px; text-align: right; font-style: italic;">Syncing to OneDrive...</div>
    </div>

    <div id="dashboard" class="section active">
        <div class="stats-container">
            <div class="stat-card">
                <h3 id="dash-households">0</h3>
                <p>Registered Households</p>
            </div>
            <div class="stat-card">
                <h3 id="dash-debt">‚Ç¶0.00</h3>
                <p>Total Village Debt</p>
            </div>
            <div class="stat-card">
                <h3 id="dash-collected">‚Ç¶0.00</h3>
                <p>Total Collected (Households)</p>
            </div>
            <div class="stat-card">
                <h3 id="dash-remitted" style="color: var(--accent);">‚Ç¶0.00</h3>
                <p>Total Remitted (Kindreds)</p>
            </div>
        </div>

        <h3>Kindred Financial Overview</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Kindred</th>
                        <th>Total Bill Allocated</th>
                        <th>Household Collections</th>
                        <th>Remitted to Admin</th>
                        <th>Outstanding Balance</th>
                    </tr>
                </thead>
                <tbody id="dash-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="register" class="section">
        <h3>Register New Household</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Kindred</label>
                <select id="reg-kindred">
                    <option value="Oduebo">Oduebo</option>
                    <option value="Oparadim">Oparadim</option>
                    <option value="Ezealaoma">Ezealaoma</option>
                </select>
            </div>
            <div class="form-group">
                <label>Sub-Kindred</label>
                <input type="text" id="reg-sub" placeholder="e.g. Umueze">
            </div>
            <div class="form-group">
                <label>Owner Name</label>
                <input type="text" id="reg-owner" placeholder="Full Name">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="reg-phone" placeholder="080...">
            </div>
        </div>
        <button class="btn btn-primary" onclick="App.registerHousehold()">Generate Account & Save</button>
    </div>

    <div id="collection" class="section">
        <div style="display: flex; justify-content: space-between;">
            <h3>Household Collection</h3>
            <button class="btn btn-warning" onclick="Router.go('search')">Find Account #</button>
        </div>
        
        <div style="background: var(--light); padding: 20px; border-radius: 8px;">
            <div class="form-grid">
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="pay-acc" placeholder="Enter ID (e.g. ODUMJO55)">
                </div>
                <div class="form-group">
                    <label>Amount (‚Ç¶)</label>
                    <input type="number" id="pay-amt" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Value Date</label>
                    <input type="date" id="pay-date">
                </div>
                <div class="form-group">
                    <label>Particulars</label>
                    <input type="text" id="pay-part" placeholder="e.g. Jan Bill / Arrears">
                </div>
            </div>
            <button class="btn btn-success" onclick="App.processCollection()">Process Payment</button>
        </div>
    </div>

    <div id="remittance" class="section">
        <h3>Kindred Bulk Remittance</h3>
        <p class="text-muted">Record bulk payments handed over by Kindred Leaders to the Administration.</p>
        
        <div style="background: #e8f6f3; padding: 20px; border-radius: 8px; border: 1px solid #d4efdf;">
            <div class="form-grid">
                <div class="form-group">
                    <label>Select Kindred</label>
                    <select id="remit-kindred">
                        <option value="Oduebo">Oduebo</option>
                        <option value="Oparadim">Oparadim</option>
                        <option value="Ezealaoma">Ezealaoma</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount Remitted (‚Ç¶)</label>
                    <input type="number" id="remit-amt">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="remit-date">
                </div>
                <div class="form-group">
                    <label>Notes / Receipt Ref</label>
                    <input type="text" id="remit-note" placeholder="Manual Receipt #">
                </div>
            </div>
            <button class="btn btn-primary" onclick="App.processRemittance()">Record Remittance</button>
        </div>

        <h4>Remittance History</h4>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr><th>Date</th><th>Kindred</th><th>Amount</th><th>Ref</th><th>Entered By</th><th>Action</th></tr>
                </thead>
                <tbody id="remit-history-body"></tbody>
            </table>
        </div>
    </div>

    <div id="reports" class="section">
        <h3>System Reports</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Report Type</label>
                <select id="report-type">
                    <option value="tx_household">Household Transactions</option>
                    <option value="tx_remittance">Kindred Remittances</option>
                    <option value="households">Registered Households</option>
                    <option value="statement">Household Statement</option>
                </select>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" style="margin-top: 22px;" onclick="App.generateReport()">Generate View</button>
            </div>
        </div>
        <div class="table-responsive">
            <table id="report-table">
                <thead id="report-head"></thead>
                <tbody id="report-body"></tbody>
            </table>
        </div>
    </div>

    <div id="billing" class="section">
        <h3>Monthly Village Billing</h3>
        <div class="alert alert-warning" style="display:block">
            Input the total bulk bill for the village. This will be automatically split 33.33% to each Kindred.
        </div>
        <div class="form-group">
            <label>Total Bill Amount (‚Ç¶)</label>
            <input type="number" id="bill-amount">
        </div>
        <button class="btn btn-primary" onclick="App.addBill()">Allocate Bill</button>
    </div>

    <div id="search" class="section">
        <h3>Search Households</h3>
        <input type="text" id="search-query" placeholder="Search Name, Phone, or Account No..." onkeyup="App.search(this.value)">
        <div class="table-responsive">
            <table>
                <thead><tr><th>Acc No</th><th>Owner</th><th>Kindred</th><th>Sub</th><th>Phone</th><th>Action</th></tr></thead>
                <tbody id="search-results"></tbody>
            </table>
        </div>
    </div>

    <div id="data" class="section">
        <h3>Data Management</h3>
        <div class="alert alert-success" id="drive-info">
            Using Physical Storage. Backups are automatic every 5 minutes to the /backups folder.
        </div>
        
        <div class="form-grid">
            <div class="stat-card">
                <h4>Manual Backup</h4>
                <p>Force a write to the physical drive now.</p>
                <button class="btn btn-primary" onclick="DataMgr.forceSaveToDrive()">Save & Backup Now</button>
            </div>
        </div>

        <div class="stat-card" style="margin-top: 20px;">
            <h4>Bulk Import Households</h4>
            <p>Supports CSV, JSON, or Excel (.xlsx). Structure: Kindred, SubKindred, Owner, Phone.</p>
            <input type="file" id="import-file">
            <button class="btn btn-success" onclick="DataMgr.importFile()">Import File</button>
        </div>
    </div>

    <div id="audit" class="section">
        <h3>System Audit Trail</h3>
        <p>Tracks Login, Collection, Remittance, and User Management.</p>
        <div class="table-responsive">
            <table>
                <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                <tbody id="audit-body"></tbody>
            </table>
        </div>
    </div>

    <div id="settings" class="section">
        <h3>User Management</h3>
        <div id="user-mgmt-form">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="set-user">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="text" id="set-pass">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="set-role">
                    <option value="collector">Collection Officer</option>
                    <option value="leader">Kindred Leader</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="App.saveUser()">Save/Update User</button>
        </div>
        
        <h4>Existing Users</h4>
        <div class="table-responsive">
            <table>
                <thead><tr><th>Username</th><th>Role</th><th>Action</th></tr></thead>
                <tbody id="user-list-body"></tbody>
            </table>
        </div>
    </div>

    <div id="wipe" class="section">
        <div style="border: 2px solid red; padding: 20px; background: #fff5f5;">
            <h2 style="color: red; margin-top: 0;">‚ö† DANGER ZONE</h2>
            <p>This will permanently delete ALL data from the connected storage file.</p>
            <input type="password" id="wipe-pass" placeholder="Superadmin Password" style="margin-bottom: 10px;">
            <button class="btn btn-danger" onclick="App.wipeData()">WIPE SYSTEM</button>
        </div>
    </div>

    <div id="change-password" class="section">
        <h3>Change Password</h3>
        <div style="max-width: 400px; margin: 0 auto;">
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="current-pass">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="new-pass">
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirm-pass">
            </div>
            <button class="btn btn-primary" onclick="App.changePassword()">Update Password</button>
            <button class="btn" onclick="Router.go('dashboard')" style="margin-left: 10px;">Cancel</button>
        </div>
    </div>

    <div id="statement" class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Statement of Account</h3>
            <button class="btn btn-primary no-print" onclick="Printer.printStatement(currentStatement)" style="display: none;" id="print-statement-btn">Print Statement</button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <div class="form-grid">
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="stmt-acc" placeholder="Enter Account No" onchange="App.loadStatement(this.value)">
                </div>
                <div class="form-group">
                    <label>Period</label>
                    <select id="stmt-period">
                        <option value="all">All Time</option>
                        <option value="current_month">Current Month</option>
                        <option value="last_30">Last 30 Days</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group" id="stmt-date-from-group" style="display: none;">
                    <label>From Date</label>
                    <input type="date" id="stmt-date-from">
                </div>
                <div class="form-group" id="stmt-date-to-group" style="display: none;">
                    <label>To Date</label>
                    <input type="date" id="stmt-date-to">
                </div>
            </div>
        </div>
        
        <div id="statement-content">
            <div style="text-align: center; padding: 40px; color: #999;" id="stmt-placeholder">
                Enter an account number to view statement
            </div>
        </div>
    </div>

    <div id="receipt-view" class="section">
        <button class="btn no-print" onclick="Router.go('dashboard')">‚Üê Dashboard</button>
        <button class="btn no-print" onclick="window.print()" style="float:right;">Print</button>
        <br><br>
        <div class="receipt-container" id="receipt-content">
        </div>
    </div>
</div>

<script>
// Global variable for current statement
let currentStatement = null;

// --- AUTOMATIC DRIVE ATTACHMENT LOGIC (IndexedDB Persistence) ---
const FileSystem = {
    dirHandle: null,
    fileHandle: null,
    isConnected: false,
    DB_NAME: "NtuDriveStore",
    
    // Attempt to recover previous link on launch
    initLink: async () => {
        try {
            const handle = await FileSystem.getStoredHandle();
            if(handle) {
                document.getElementById('storage-msg').innerText = "Found previous link: " + handle.name;
                document.getElementById('btn-connect-drive').innerText = "‚ö° Verify OneDrive Link";
                document.getElementById('history-hint').innerText = "Click verify to re-enable sync.";
                
                // AUTO-RECONNECT: Try to reconnect automatically without user gesture
                setTimeout(async () => {
                    try {
                        const opt = { mode: 'readwrite' };
                        if (await handle.queryPermission(opt) === 'granted') {
                            // We have permission, reconnect automatically
                            FileSystem.dirHandle = handle;
                            FileSystem.fileHandle = await FileSystem.dirHandle.getFileHandle('database.json', { create: true });
                            FileSystem.isConnected = true;
                            document.getElementById('status-dot').classList.add('active');
                            document.getElementById('status-text').innerText = "OneDrive Active (" + FileSystem.dirHandle.name + ")";
                            document.getElementById('storage-msg').innerText = "‚úÖ Auto-synced: " + FileSystem.dirHandle.name;
                            document.getElementById('storage-msg').style.color = "var(--storage-ok)";
                            
                            await DataMgr.loadFromDrive();
                            setInterval(DataMgr.autoBackup, 300000);
                        }
                    } catch(e) {
                        console.log("Auto-reconnect failed, user will need to manually connect");
                    }
                }, 500); // Small delay to let UI render
            } else {
                document.getElementById('storage-msg').innerText = "Not Connected";
            }
        } catch(e) {
            console.log("No previous link found.");
        }
    },

    // Save handle to IndexedDB (Persistent across browser close)
    storeHandle: async (handle) => {
        const db = await FileSystem.openDB();
        const tx = db.transaction("handles", "readwrite");
        tx.objectStore("handles").put(handle, "lastFolder");
    },

    getStoredHandle: async () => {
        const db = await FileSystem.openDB();
        return new Promise((resolve) => {
            const req = db.transaction("handles").objectStore("handles").get("lastFolder");
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => resolve(null);
        });
    },

    openDB: () => {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(FileSystem.DB_NAME, 1);
            req.onupgradeneeded = () => req.result.createObjectStore("handles");
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    },

    // Connect/Verify
    connect: async () => {
        try {
            let handle = await FileSystem.getStoredHandle();
            
            // If we have a handle, check permissions
            if(handle) {
                const opt = { mode: 'readwrite' };
                if (await handle.queryPermission(opt) !== 'granted') {
                    if (await handle.requestPermission(opt) !== 'granted') {
                        // User denied or closed, reset to picker
                        handle = await window.showDirectoryPicker();
                    }
                }
            } else {
                // No history, use picker
                handle = await window.showDirectoryPicker();
            }

            FileSystem.dirHandle = handle;
            await FileSystem.storeHandle(handle);

            // Check/Create database.json
            FileSystem.fileHandle = await FileSystem.dirHandle.getFileHandle('database.json', { create: true });
            
            // Check/Create backup folder
            await FileSystem.dirHandle.getDirectoryHandle('backups', { create: true });

            FileSystem.isConnected = true;
            document.getElementById('status-dot').classList.add('active');
            document.getElementById('status-text').innerText = "OneDrive Active (" + FileSystem.dirHandle.name + ")";
            document.getElementById('storage-msg').innerText = "‚úÖ Synced: " + FileSystem.dirHandle.name;
            document.getElementById('storage-msg').style.color = "var(--storage-ok)";
            
            await DataMgr.loadFromDrive();
            setInterval(DataMgr.autoBackup, 300000); 

        } catch (err) {
            console.error(err);
            alert("Could not establish OneDrive link. Check browser permissions.");
        }
    }
};

// --- DATABASE MANAGER ---
const DataMgr = {
    data: {
        users: [
            { user: 'Superadmin', pass: 'supro123', role: 'superadmin' },
            { user: 'Admin', pass: 'admin123', role: 'admin' }
        ],
        households: [],
        ledgers: {
            'Oduebo': { debt: 0, remitted: 0 },
            'Oparadim': { debt: 0, remitted: 0 },
            'Ezealaoma': { debt: 0, remitted: 0 }
        },
        transactions: [],
        remittances: [],
        audit: []
    },

    save: async () => {
        if(FileSystem.isConnected) {
            document.getElementById('autosave-indicator').style.display = 'block';
            try {
                const writable = await FileSystem.fileHandle.createWritable();
                await writable.write(JSON.stringify(DataMgr.data, null, 2));
                await writable.close();
                setTimeout(() => document.getElementById('autosave-indicator').style.display = 'none', 1000);
            } catch(e) {
                console.error("Save failed", e);
                UI.globalAlert("OneDrive Save Failed!", "error");
            }
        } else {
            localStorage.setItem('ntu_db_v3', JSON.stringify(DataMgr.data));
        }
    },

    loadFromDrive: async () => {
        if(!FileSystem.isConnected) return;
        try {
            const file = await FileSystem.fileHandle.getFile();
            const text = await file.text();
            if(text) {
                DataMgr.data = JSON.parse(text);
                console.log("Data loaded from OneDrive");
                if(Auth.user) Router.init(); 
            }
        } catch(e) {
            console.log("New database initialized.");
            DataMgr.save(); 
        }
    },

    init: () => {
        const local = localStorage.getItem('ntu_db_v3');
        if(local) DataMgr.data = JSON.parse(local);
        FileSystem.initLink(); // Initialize History Check
    },

    forceSaveToDrive: async () => {
        await DataMgr.save();
        await DataMgr.autoBackup();
        UI.globalAlert("Synced to OneDrive.", "success");
    },

    autoBackup: async () => {
        if(!FileSystem.isConnected) return;
        try {
            const backupDir = await FileSystem.dirHandle.getDirectoryHandle('backups');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `backup_${timestamp}.json`;
            const fileHandle = await backupDir.getFileHandle(filename, { create: true });
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(DataMgr.data, null, 2));
            await writable.close();
            console.log("Backup synced: " + filename);
        } catch(e) {
            console.error("Backup failed", e);
        }
    },

    log: (action, details) => {
        DataMgr.data.audit.unshift({
            time: new Date().toLocaleString(),
            user: Auth.user ? Auth.user.user : 'System',
            action: action,
            details: details
        });
        DataMgr.save();
    },

    importFile: () => {
        const file = document.getElementById('import-file').files[0];
        if(!file) return alert('Select file');
        const ext = file.name.split('.').pop().toLowerCase();
        const reader = new FileReader();
        
        if(ext === 'json') {
            reader.onload = (e) => DataMgr.processImportData(JSON.parse(e.target.result));
            reader.readAsText(file);
        } else if (ext === 'csv') {
            reader.onload = (e) => {
                const lines = e.target.result.split('\n');
                const data = [];
                for(let i=1; i<lines.length; i++) {
                    const c = lines[i].split(',');
                    if(c.length >= 4) data.push({Kindred:c[0], Sub:c[1], Owner:c[2], Phone:c[3]});
                }
                DataMgr.processImportData(data);
            };
            reader.readAsText(file);
        } else if (ext === 'xlsx' || ext === 'xls') {
            if(typeof XLSX === 'undefined') return alert('Internet required for Excel import. Use CSV if offline.');
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, {type: 'binary'});
                const sheet = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(sheet);
                DataMgr.processImportData(data);
            };
            reader.readAsBinaryString(file);
        }
    },

    processImportData: (data) => {
        let count = 0;
        data.forEach(row => {
            const k = row.Kindred || row.kindred;
            const s = row.Sub || row.SubKindred || row.sub;
            const o = row.Owner || row.Name || row.owner;
            const p = row.Phone || row.phone;
            if(k && s && o && p) {
                const pStr = String(p);
                const id = App.generateID(k, s, o, pStr);
                if(!DataMgr.data.households.find(h => h.id === id)) {
                    DataMgr.data.households.push({ id, kindred: k, sub: s, owner: o, phone: pStr, date: new Date().toISOString() });
                    count++;
                }
            }
        });
        DataMgr.save();
        DataMgr.log('IMPORT', `Imported ${count} households`);
        alert(`Successfully imported ${count} households.`);
        Router.go('dashboard');
    }
};

// --- AUTHENTICATION ---
const Auth = {
    user: null,
    login: () => {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const users = DataMgr.data.users;
        const found = users.find(x => x.user.toLowerCase() === u.toLowerCase() && x.pass === p);
        
        if(found) {
            Auth.user = found;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            DataMgr.log('LOGIN', 'User logged in');
            Router.init();
        } else {
            UI.alert('login-alert', 'Invalid credentials', 'error');
        }
    },
    logout: () => {
        DataMgr.log('LOGOUT', 'User logged out');
        location.reload();
    }
};

// --- ROUTER & PERMISSIONS ---
const Router = {
    init: () => {
        const role = Auth.user.role;
        const badgeClass = `badge-${role}`;
        
        document.getElementById('user-role-display').innerHTML = `
            Logged in as: <strong>${Auth.user.user}</strong> <span class="badge ${badgeClass}">${role.toUpperCase()}</span>`;
        
        document.getElementById('admin-menu').classList.add('hidden');
        document.getElementById('field-menu').classList.add('hidden');
        document.getElementById('nav-audit').classList.add('hidden');
        document.getElementById('nav-wipe').classList.add('hidden');

        if(role === 'collector' || role === 'leader') {
            document.getElementById('field-menu').classList.remove('hidden');
        }

        if(role === 'admin' || role === 'superadmin') {
            document.getElementById('admin-menu').classList.remove('hidden');
        }

        if(role === 'superadmin') {
            document.getElementById('nav-audit').classList.remove('hidden');
            document.getElementById('nav-wipe').classList.remove('hidden');
        }

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('pay-date').value = today;
        document.getElementById('remit-date').value = today;
        
        // Add event listener for statement period change
        document.getElementById('stmt-period').addEventListener('change', function() {
            const isCustom = this.value === 'custom';
            document.getElementById('stmt-date-from-group').style.display = isCustom ? 'block' : 'none';
            document.getElementById('stmt-date-to-group').style.display = isCustom ? 'block' : 'none';
            
            // Load statement again if there's an account
            const acc = document.getElementById('stmt-acc').value;
            if(acc) App.loadStatement(acc);
        });
        
        // Set default dates for custom period
        const todayDate = new Date();
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        document.getElementById('stmt-date-from').value = lastMonth.toISOString().split('T')[0];
        document.getElementById('stmt-date-to').value = todayDate.toISOString().split('T')[0];

        Router.go('dashboard');
    },
    go: (pageId) => {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        const target = document.getElementById(pageId);
        const btn = document.getElementById('nav-'+pageId);
        const btnField = document.getElementById('nav-register-field');
        
        if(target) target.classList.add('active');
        if(btn) btn.classList.add('active');
        if(pageId === 'register' && btnField) btnField.classList.add('active');
        if(pageId === 'statement' && document.getElementById('nav-statement')) {
            document.getElementById('nav-statement').classList.add('active');
        }

        if(pageId === 'dashboard') App.loadDashboard();
        if(pageId === 'remittance') App.loadRemittances();
        if(pageId === 'audit') App.loadAudit();
        if(pageId === 'settings') App.loadUsers();
        if(pageId === 'statement') {
            document.getElementById('print-statement-btn').style.display = 'none';
            const acc = document.getElementById('stmt-acc').value;
            if(acc) App.loadStatement(acc);
        }
    }
};

// --- MAIN APPLICATION LOGIC ---
const App = {
    generateID: (kindred, sub, owner, phone) => {
        const p1 = kindred.substring(0, 2).toUpperCase().padEnd(2,'X');
        const p2 = sub.substring(0, 2).toUpperCase().padEnd(2,'X');
        const p3 = owner.substring(0, 2).toUpperCase().padEnd(2,'X');
        const p4 = phone.length >= 2 ? phone.slice(-2) : "00";
        return p1 + p2 + p3 + p4;
    },

    registerHousehold: () => {
        const k = document.getElementById('reg-kindred').value;
        const s = document.getElementById('reg-sub').value;
        const o = document.getElementById('reg-owner').value;
        const p = document.getElementById('reg-phone').value;

        if(!s || !o || !p) return UI.globalAlert('Fill all fields', 'error');

        const id = App.generateID(k, s, o, p);
        if(DataMgr.data.households.find(h => h.id === id)) return UI.globalAlert('Account Exists: ' + id, 'error');

        DataMgr.data.households.push({ id, kindred: k, sub: s, owner: o, phone: p, date: new Date().toISOString() });
        DataMgr.log('REGISTER', `New Household: ${id}`);
        DataMgr.save();
        
        if(confirm(`Registered! Account: ${id}. Print Slip?`)) {
            Printer.printRegistration({id, kindred:k, sub:s, owner:o, phone:p});
        } else {
            document.getElementById('reg-owner').value = '';
            document.getElementById('reg-phone').value = '';
        }
    },

    processCollection: () => {
        const id = document.getElementById('pay-acc').value;
        const amt = parseFloat(document.getElementById('pay-amt').value);
        const date = document.getElementById('pay-date').value;
        const part = document.getElementById('pay-part').value;

        if(!id || !amt || !date) return UI.globalAlert('Missing payment details', 'error');
        const house = DataMgr.data.households.find(h => h.id === id);
        if(!house) return UI.globalAlert('Invalid Account Number', 'error');

        const ref = 'TX' + Date.now().toString().slice(-6);
        const tx = { ref, acc: id, kindred: house.kindred, owner: house.owner, amount: amt, date, particulars: part, by: Auth.user.user };

        DataMgr.data.transactions.push(tx);
        DataMgr.log('COLLECTION', `Received ${amt} from ${id}`);
        DataMgr.save();

        Printer.printCollection(tx);
        document.getElementById('pay-amt').value = '';
        document.getElementById('pay-part').value = '';
    },

    processRemittance: () => {
        const k = document.getElementById('remit-kindred').value;
        const amt = parseFloat(document.getElementById('remit-amt').value);
        const date = document.getElementById('remit-date').value;
        const note = document.getElementById('remit-note').value;

        if(!amt || !date) return UI.globalAlert('Enter amount and date', 'error');

        DataMgr.data.ledgers[k].remitted += amt;
        const remitObj = { date, kindred: k, amount: amt, ref: note, by: Auth.user.user };
        DataMgr.data.remittances.push(remitObj);

        DataMgr.log('REMITTANCE', `${k} remitted ${amt}`);
        DataMgr.save();
        UI.globalAlert('Remittance Recorded', 'success');
        App.loadRemittances();

        if(confirm('Print Remittance Receipt?')) {
            Printer.printRemittance(remitObj);
        }
    },

    loadRemittances: () => {
        const list = DataMgr.data.remittances.slice().reverse();
        let html = '';
        list.forEach(r => {
            html += `<tr>
                <td>${r.date}</td>
                <td>${r.kindred}</td>
                <td>‚Ç¶${r.amount.toFixed(2)}</td>
                <td>${r.ref}</td>
                <td>${r.by}</td>
                <td><button class="btn btn-sm btn-primary" onclick='Printer.printRemittance(${JSON.stringify(r)})'>Print</button></td>
            </tr>`;
        });
        document.getElementById('remit-history-body').innerHTML = html;
    },

    addBill: () => {
        const amt = parseFloat(document.getElementById('bill-amount').value);
        if(!amt) return;
        const share = amt / 3;
        ['Oduebo', 'Oparadim', 'Ezealaoma'].forEach(k => {
            DataMgr.data.ledgers[k].debt += share;
        });
        DataMgr.log('BILLING', `Allocated total bill ${amt}`);
        DataMgr.save();
        UI.globalAlert('Bill Allocated Successfully', 'success');
    },

    loadDashboard: () => {
        const h = DataMgr.data.households;
        const txs = DataMgr.data.transactions;
        const l = DataMgr.data.ledgers;

        document.getElementById('dash-households').innerText = h.length;

        let totalDebt = 0;
        let totalRemitted = 0;
        let totalCollected = txs.reduce((sum, t) => sum + t.amount, 0);
        let tableHtml = '';

        for(let k in l) {
            totalDebt += l[k].debt;
            totalRemitted += l[k].remitted;
            const kindredCollected = txs.filter(t => t.kindred === k).reduce((s,t) => s + t.amount, 0);
            const balance = l[k].debt - l[k].remitted;

            tableHtml += `
                <tr>
                    <td>${k}</td>
                    <td>‚Ç¶${l[k].debt.toFixed(2)}</td>
                    <td>‚Ç¶${kindredCollected.toFixed(2)}</td>
                    <td>‚Ç¶${l[k].remitted.toFixed(2)}</td>
                    <td style="color:${balance > 0 ? 'red':'green'}">‚Ç¶${balance.toFixed(2)}</td>
                </tr>`;
        }
        document.getElementById('dash-debt').innerText = '‚Ç¶' + totalDebt.toFixed(2);
        document.getElementById('dash-collected').innerText = '‚Ç¶' + totalCollected.toFixed(2);
        document.getElementById('dash-remitted').innerText = '‚Ç¶' + totalRemitted.toFixed(2);
        document.getElementById('dash-table-body').innerHTML = tableHtml;
    },

    search: (q) => {
        q = q.toLowerCase();
        if(q.length < 2) return;
        const res = DataMgr.data.households.filter(h => 
            h.id.toLowerCase().includes(q) || h.owner.toLowerCase().includes(q) || h.phone.includes(q)
        );
        let html = '';
        res.forEach(r => {
            html += `<tr>
                <td>${r.id}</td><td>${r.owner}</td><td>${r.kindred}</td><td>${r.sub}</td><td>${r.phone}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="App.prefillPay('${r.id}')">Pay</button>
                    <button class="btn btn-info btn-sm" onclick="App.generateStatement('${r.id}')" style="margin-left: 5px;">Statement</button>
                </td>
            </tr>`;
        });
        document.getElementById('search-results').innerHTML = html;
    },
    prefillPay: (id) => {
        document.getElementById('pay-acc').value = id;
        Router.go('collection');
    },
    
    generateStatement: (accountId) => {
        document.getElementById('stmt-acc').value = accountId;
        Router.go('statement');
        setTimeout(() => App.loadStatement(accountId), 100);
    },

    generateReport: () => {
        const type = document.getElementById('report-type').value;
        const thead = document.getElementById('report-head');
        const tbody = document.getElementById('report-body');
        tbody.innerHTML = '';
        
        if(type === 'statement') {
            // Redirect to statement section
            Router.go('statement');
            return;
        } else if(type === 'tx_household') {
            thead.innerHTML = '<tr><th>Date</th><th>Ref</th><th>Acc</th><th>Kindred</th><th>Amount</th><th>Particulars</th></tr>';
            DataMgr.data.transactions.forEach(d => {
                tbody.innerHTML += `<tr><td>${d.date}</td><td>${d.ref}</td><td>${d.acc}</td><td>${d.kindred}</td><td>${d.amount}</td><td>${d.particulars}</td></tr>`;
            });
        } else if (type === 'tx_remittance') {
            thead.innerHTML = '<tr><th>Date</th><th>Kindred</th><th>Amount</th><th>Ref</th><th>By</th></tr>';
            DataMgr.data.remittances.forEach(d => {
                tbody.innerHTML += `<tr><td>${d.date}</td><td>${d.kindred}</td><td>${d.amount}</td><td>${d.ref}</td><td>${d.by}</td></tr>`;
            });
        } else {
            thead.innerHTML = '<tr><th>ID</th><th>Owner</th><th>Kindred</th><th>Sub</th><th>Phone</th></tr>';
            DataMgr.data.households.forEach(d => {
                tbody.innerHTML += `<tr><td>${d.id}</td><td>${d.owner}</td><td>${d.kindred}</td><td>${d.sub}</td><td>${d.phone}</td></tr>`;
            });
        }
    },

    loadAudit: () => {
        const data = DataMgr.data.audit;
        let html = '';
        data.forEach(a => {
            html += `<tr><td>${a.time}</td><td>${a.user}</td><td>${a.action}</td><td>${a.details}</td></tr>`;
        });
        document.getElementById('audit-body').innerHTML = html;
    },

    loadUsers: () => {
        const users = DataMgr.data.users;
        const currentUser = Auth.user;
        let html = '';
        
        const canCreate = (currentUser.role === 'superadmin');
        document.getElementById('user-mgmt-form').style.display = canCreate ? 'block' : 'none';

        users.forEach(u => {
            let actions = '';
            if(currentUser.role === 'superadmin' && u.role !== 'superadmin') {
                actions = `<button class="btn btn-danger btn-sm" onclick="App.deleteUser('${u.user}')">Delete</button>`;
            }
            html += `<tr><td>${u.user}</td><td>${u.role}</td><td>${actions}</td></tr>`;
        });
        document.getElementById('user-list-body').innerHTML = html;
    },

    saveUser: () => {
        const u = document.getElementById('set-user').value;
        const p = document.getElementById('set-pass').value;
        const r = document.getElementById('set-role').value;
        if(!u || !p) return;
        
        if(r === 'admin' && Auth.user.role !== 'superadmin') return alert("Only Superadmin can create Admins.");

        const users = DataMgr.data.users;
        const idx = users.findIndex(x => x.user === u);
        
        if(idx > -1) users[idx] = { user:u, pass:p, role:r };
        else users.push({ user:u, pass:p, role:r });
        
        DataMgr.log('USER_MGMT', `Updated/Created user ${u} as ${r}`);
        DataMgr.save();
        UI.globalAlert('User Saved', 'success');
        App.loadUsers();
    },

    deleteUser: (username) => {
        if(confirm(`Delete user ${username}?`)) {
            DataMgr.data.users = DataMgr.data.users.filter(u => u.user !== username);
            DataMgr.log('USER_MGMT', `Deleted user ${username}`);
            DataMgr.save();
            App.loadUsers();
        }
    },

    wipeData: () => {
        if(document.getElementById('wipe-pass').value === 'supro123') {
            if(confirm('ARE YOU SURE? THIS IS PERMANENT.')) {
                DataMgr.data.households = [];
                DataMgr.data.transactions = [];
                DataMgr.data.ledgers = {
                    'Oduebo': { debt: 0, remitted: 0 },
                    'Oparadim': { debt: 0, remitted: 0 },
                    'Ezealaoma': { debt: 0, remitted: 0 }
                };
                DataMgr.data.remittances = [];
                DataMgr.data.audit = [];
                DataMgr.data.users = [{ user: 'Superadmin', pass: 'supro123', role: 'superadmin' }];
                
                DataMgr.save();
                alert('SYSTEM WIPED');
                location.reload();
            }
        } else {
            alert('Wrong Password');
        }
    },
    
    // --- Password Change Functions ---
    showChangePassword: () => {
        Router.go('change-password');
    },
    
    changePassword: () => {
        const current = document.getElementById('current-pass').value;
        const newPass = document.getElementById('new-pass').value;
        const confirm = document.getElementById('confirm-pass').value;
        
        if(!current || !newPass || !confirm) {
            return UI.globalAlert('All fields are required', 'error');
        }
        
        if(newPass !== confirm) {
            return UI.globalAlert('New passwords do not match', 'error');
        }
        
        if(Auth.user.pass !== current) {
            return UI.globalAlert('Current password is incorrect', 'error');
        }
        
        // Update password
        const userIndex = DataMgr.data.users.findIndex(u => u.user === Auth.user.user);
        if(userIndex !== -1) {
            DataMgr.data.users[userIndex].pass = newPass;
            Auth.user.pass = newPass; // Update current session
            DataMgr.save();
            DataMgr.log('PASSWORD_CHANGE', 'User changed password');
            UI.globalAlert('Password updated successfully', 'success');
            
            // Clear form
            document.getElementById('current-pass').value = '';
            document.getElementById('new-pass').value = '';
            document.getElementById('confirm-pass').value = '';
            
            // Return to dashboard
            setTimeout(() => Router.go('dashboard'), 1500);
        }
    },
    
    // --- Statement of Account Functions ---
    loadStatement: (accountNo) => {
        if(!accountNo) return;
        
        const house = DataMgr.data.households.find(h => h.id === accountNo);
        if(!house) {
            document.getElementById('statement-content').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #c0392b;">
                    Account not found: ${accountNo}
                </div>`;
            document.getElementById('print-statement-btn').style.display = 'none';
            return;
        }
        
        // Get transactions for this account
        const period = document.getElementById('stmt-period').value;
        let filteredTxs = DataMgr.data.transactions.filter(t => t.acc === accountNo);
        
        // Filter by period if needed
        if(period !== 'all') {
            const now = new Date();
            if(period === 'current_month') {
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                filteredTxs = filteredTxs.filter(t => t.date >= firstDay);
            } else if(period === 'last_30') {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const dateStr = thirtyDaysAgo.toISOString().split('T')[0];
                filteredTxs = filteredTxs.filter(t => t.date >= dateStr);
            } else if(period === 'custom') {
                const fromDate = document.getElementById('stmt-date-from').value;
                const toDate = document.getElementById('stmt-date-to').value;
                if(fromDate && toDate) {
                    filteredTxs = filteredTxs.filter(t => t.date >= fromDate && t.date <= toDate);
                }
            }
        }
        
        // Sort by date (newest first)
        filteredTxs.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Calculate totals
        const totalPaid = filteredTxs.reduce((sum, t) => sum + t.amount, 0);
        
        // Get kindred info
        const kindredLedger = DataMgr.data.ledgers[house.kindred] || { debt: 0, remitted: 0 };
        
        // Create statement HTML
        let txsHtml = '';
        filteredTxs.forEach((tx, index) => {
            txsHtml += `
                <tr>
                    <td>${tx.date}</td>
                    <td>${tx.ref}</td>
                    <td>${tx.particulars}</td>
                    <td style="text-align: right;">‚Ç¶${tx.amount.toFixed(2)}</td>
                </tr>`;
        });
        
        if(filteredTxs.length === 0) {
            txsHtml = `<tr><td colspan="4" style="text-align: center; color: #999;">No transactions found for selected period</td></tr>`;
        }
        
        const statementHtml = `
            <div style="border: 1px solid #ccc; padding: 20px; background: white; border-radius: 8px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">NTU ELECTRICITY</h2>
                    <h3 style="margin: 5px 0;">STATEMENT OF ACCOUNT</h3>
                    <p style="margin: 0; font-size: 12px;">Generated on ${new Date().toLocaleDateString()}</p>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <p><strong>Account No:</strong> ${house.id}</p>
                        <p><strong>Name:</strong> ${house.owner}</p>
                        <p><strong>Kindred:</strong> ${house.kindred} (${house.sub})</p>
                        <p><strong>Phone:</strong> ${house.phone}</p>
                    </div>
                    <div style="flex: 1; min-width: 250px; text-align: right;">
                        <p><strong>Statement Period:</strong> ${period === 'all' ? 'All Time' : period}</p>
                        <p><strong>Total Transactions:</strong> ${filteredTxs.length}</p>
                        <p><strong>Account Created:</strong> ${new Date(house.date).toLocaleDateString()}</p>
                    </div>
                </div>
                
                <hr style="border-top: 1px solid #000;">
                
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px;">Date</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Ref No</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Particulars</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Amount (‚Ç¶)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${txsHtml}
                    </tbody>
                </table>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 20px;">
                    <h4 style="margin: 0 0 10px 0;">SUMMARY</h4>
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <p><strong>Total Amount Paid:</strong></p>
                            <p><strong>Kindred Allocation:</strong></p>
                            <p><strong>Kindred Remitted:</strong></p>
                            <p style="color: var(--accent);"><strong>Account Status:</strong></p>
                        </div>
                        <div style="flex: 1; min-width: 200px; text-align: right;">
                            <p><strong>‚Ç¶${totalPaid.toFixed(2)}</strong></p>
                            <p>‚Ç¶${kindredLedger.debt.toFixed(2)}</p>
                            <p>‚Ç¶${kindredLedger.remitted.toFixed(2)}</p>
                            <p style="color: var(--accent);"><strong>ACTIVE</strong></p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; font-size: 11px; color: #777; text-align: center;">
                    <p>This is a computer-generated statement. No signature required.</p>
                    <p>For inquiries, contact your Kindred Leader or Administration.</p>
                </div>
            </div>`;
        
        document.getElementById('statement-content').innerHTML = statementHtml;
        
        // Store current statement for printing
        currentStatement = {
            account: house,
            transactions: filteredTxs,
            totalPaid: totalPaid,
            kindredLedger: kindredLedger,
            period: period,
            generatedDate: new Date().toLocaleDateString()
        };
        
        document.getElementById('print-statement-btn').style.display = 'inline-block';
    }
};

// --- PRINTER (RECEIPTS) ---
const Printer = {
    render: (html) => {
        document.getElementById('receipt-content').innerHTML = html;
        Router.go('receipt-view');
    },

    printCollection: (tx) => {
        Printer.render(`
            <div style="text-align: center;">
                <h3>NTU ELECTRICITY</h3>
                <p>PAYMENT RECEIPT</p>
            </div>
            <hr style="border-top: 1px dashed #000;">
            <p><strong>Date:</strong> ${tx.date}</p>
            <p><strong>Ref:</strong> ${tx.ref}</p>
            <p><strong>Account:</strong> ${tx.acc}</p>
            <p><strong>Name:</strong> ${tx.owner}</p>
            <p><strong>Kindred:</strong> ${tx.kindred}</p>
            <p><strong>Particulars:</strong> ${tx.particulars}</p>
            <hr style="border-top: 1px dashed #000;">
            <h3 style="text-align: right;">‚Ç¶${tx.amount.toFixed(2)}</h3>
            <hr style="border-top: 1px dashed #000;">
            <p style="text-align: center; font-size: 11px;">Served by: ${tx.by}</p>
        `);
    },

    printRegistration: (data) => {
        Printer.render(`
            <div style="text-align: center;">
                <h3>NTU ELECTRICITY</h3>
                <p>NEW ACCOUNT SLIP</p>
            </div>
            <hr style="border-top: 1px dashed #000;">
            <h2 style="text-align:center">${data.id}</h2>
            <p><strong>Name:</strong> ${data.owner}</p>
            <p><strong>Kindred:</strong> ${data.kindred}</p>
            <p><strong>Sub:</strong> ${data.sub}</p>
            <p><strong>Phone:</strong> ${data.phone}</p>
            <hr style="border-top: 1px dashed #000;">
            <p style="text-align: center; font-size: 11px;">Please keep your Account Number safe.</p>
        `);
    },

    printRemittance: (remit) => {
        Printer.render(`
            <div style="text-align: center;">
                <h3>NTU ELECTRICITY</h3>
                <p>OFFICIAL REMITTANCE</p>
            </div>
            <hr style="border-top: 1px dashed #000;">
            <p><strong>Date:</strong> ${remit.date}</p>
            <p><strong>Kindred:</strong> ${remit.kindred}</p>
            <p><strong>Reference:</strong> ${remit.ref}</p>
            <hr style="border-top: 1px dashed #000;">
            <h3 style="text-align: right;">‚Ç¶${remit.amount.toFixed(2)}</h3>
            <hr style="border-top: 1px dashed #000;">
            <p style="text-align: center; font-size: 11px;">Received by Admin: ${remit.by}</p>
        `);
    },
    
    printStatement: (stmtData) => {
        if(!stmtData) {
            alert("No statement data to print");
            return;
        }
        
        let txsHtml = '';
        stmtData.transactions.forEach(tx => {
            txsHtml += `
                <tr>
                    <td>${tx.date}</td>
                    <td>${tx.ref}</td>
                    <td>${tx.particulars}</td>
                    <td style="text-align: right;">‚Ç¶${tx.amount.toFixed(2)}</td>
                </tr>`;
        });
        
        if(stmtData.transactions.length === 0) {
            txsHtml = `<tr><td colspan="4" style="text-align: center;">No transactions</td></tr>`;
        }
        
        Printer.render(`
            <div style="text-align: center;">
                <h2>NTU ELECTRICITY</h2>
                <h3>STATEMENT OF ACCOUNT</h3>
                <p>Generated on ${stmtData.generatedDate}</p>
            </div>
            <hr style="border-top: 1px dashed #000;">
            <p><strong>Account No:</strong> ${stmtData.account.id}</p>
            <p><strong>Name:</strong> ${stmtData.account.owner}</p>
            <p><strong>Kindred:</strong> ${stmtData.account.kindred} (${stmtData.account.sub})</p>
            <p><strong>Phone:</strong> ${stmtData.account.phone}</p>
            <p><strong>Period:</strong> ${stmtData.period === 'all' ? 'All Time' : stmtData.period}</p>
            <hr style="border-top: 1px dashed #000;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="border-bottom:1px solid #000;">Date</th>
                        <th style="border-bottom:1px solid #000;">Ref</th>
                        <th style="border-bottom:1px solid #000;">Particulars</th>
                        <th style="border-bottom:1px solid #000; text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${txsHtml}
                </tbody>
            </table>
            <hr style="border-top: 1px dashed #000;">
            <h3 style="text-align: right;">Total Paid: ‚Ç¶${stmtData.totalPaid.toFixed(2)}</h3>
            <hr style="border-top: 1px dashed #000;">
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <div>
                    <p><strong>Kindred Allocation:</strong> ‚Ç¶${stmtData.kindredLedger.debt.toFixed(2)}</p>
                    <p><strong>Kindred Remitted:</strong> ‚Ç¶${stmtData.kindredLedger.remitted.toFixed(2)}</p>
                </div>
                <div>
                    <p><strong>Account Status:</strong> ACTIVE</p>
                </div>
            </div>
            <hr style="border-top: 1px dashed #000;">
            <p style="text-align: center; font-size: 11px;">Official Statement - NTU Electricity System</p>
        `);
    }
};

const UI = {
    alert: (id, msg, type) => {
        const el = document.getElementById(id);
        el.innerText = msg;
        el.className = `alert alert-${type}`;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    },
    globalAlert: (msg, type) => UI.alert('global-alert', msg, type)
};

DataMgr.init();
</script>
</body>
</html>
